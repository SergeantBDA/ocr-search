{% extends "_layout.html" %}
{% block content %}
<div class="full-bleed">
  <div class="card">
    <div class="page-header">
      <h2>Извлечение текста (OCR) и поиск документов</h2>
      {% if current_user and current_user.email %}
        <a href="#" onclick="doLogout?.(); return false;" class="logout-link">Выйти ({{ current_user.email }})</a>
      {% endif %}
    </div>
    <!-- Форма поиска (GET, HTMX) — заполняет только #results -->
    <form
      id="searchForm"
      hx-get="{{ request.url_for('search').path }}"
      hx-target="#results"
      hx-swap="innerHTML"
      hx-indicator="#search-spinner"
      class="field"
      style="margin-top:12px;"
      hx-on:submit="try{document.querySelectorAll('[id^=job-]').forEach(n=>n.remove()); localStorage.setItem('ocr_jobs','[]');}catch(e){}">
      <div class="row search-row">
        <input type="text" name="q" placeholder="Введите запрос..." class="w-50" />
        <input type="text" name="ocr_user" class="auto" placeholder="user/email" />
        <div class="inline-field auto">
          <label for="ocr_from" class="form-label">от</label>
          <input type="datetime-local" name="ocr_from" />
        </div>
        <div class="inline-field auto">
          <label for="ocr_to" class="form-label">до</label>
          <input type="datetime-local" name="ocr_to" />
        </div>
        <!-- Кнопка со спинером -->
        <button class="btn" type="submit"
          hx-on:htmx:beforeRequest="this.disabled=true; this.setAttribute('aria-busy','true')"
          hx-on:htmx:afterOnLoad="this.disabled=false; this.removeAttribute('aria-busy')"
          hx-on:htmx:responseError="this.disabled=false; this.removeAttribute('aria-busy')">
          <span class="label">Поиск</span>
          <span id="search-spinner" class="spinner htmx-indicator" aria-hidden="true"></span>
        </button>
      </div>
    </form>
    <hr />
    <!-- Форма загрузки (POST, HTMX) — уведомления только в #notifications -->
    <form
      id="uploadForm"
      hx-post="{{ request.url_for('upload').path }}"
      hx-target="#notifications"
      hx-swap="afterbegin"
      hx-encoding="multipart/form-data"
      hx-indicator="#upload-spinner"
      class="field">
      <div class="row upload-row">
        <input type="file" name="files" multiple accept="*.*" />
        <button class="btn" type="submit"
          hx-on:htmx:beforeRequest="this.disabled=true; this.setAttribute('aria-busy','true')"
          hx-on:htmx:afterOnLoad="this.disabled=false; this.removeAttribute('aria-busy')"
          hx-on:htmx:responseError="this.disabled=false; this.removeAttribute('aria-busy')">
          <span class="label">Загрузить</span>
          <span id="upload-spinner" class="spinner htmx-indicator" aria-hidden="true"></span>
        </button>
      </div>
    </form>
    <hr />
    <!-- Результаты поиска -->
    <div id="results" class="results-wrap">
      <div class="area-spinner htmx-indicator" aria-hidden="true"></div>
      {% include "_results.html" %}
    </div>
    <!-- Зона уведомлений (прогресс/готово) -->
    <div id="notifications" class="toasts"></div>
    <!-- Восстановление активных задач после F5 -->
    <script>
      (function restoreJobs(){
        const idsKey = "ocr_jobs";
        const tsKey  = "ocr_job_times";
        const MAX_KEEP = 24 * 3600 * 1000; // хранить не дольше суток
    
        // Очистить протухшие job'ы по времени
        const now = Date.now();
        const times = JSON.parse(localStorage.getItem(tsKey) || "{}");
        for (const id in times) {
          if ((now - Number(times[id] || 0)) > MAX_KEEP) {
            delete times[id];
          }
        }
        localStorage.setItem(tsKey, JSON.stringify(times));
    
        // Пересобрать список id с учётом очистки
        let ids = JSON.parse(localStorage.getItem(idsKey) || "[]").filter(id => id in times);
        if (!ids.length) { localStorage.setItem(idsKey, "[]"); return; }
    
        const notif = document.getElementById("notifications");
        if (!notif) return;
    
        // Создаём «пустые» тосты — HTMX подменит их ответом /jobs/{id}
        const html = ids.map(id => (`
          <div id="job-${id}"
              class="toast"
              style="--pct: 0%"
              hx-get="/jobs/${id}"
              hx-trigger="load, every 5s [document.visibilityState === 'visible']"
              hx-swap="outerHTML">
            <div class="toast-title">Обработка…</div>
            <div class="toast-body">
              Прогресс: <span class="pct">0%</span>
              <div class="progress"><div class="bar"></div></div>
            </div>
          </div>
        `)).join("");
    
        notif.insertAdjacentHTML("afterbegin", html);
        if (window.htmx && typeof htmx.process === "function") {
          htmx.process(notif);
        }
      })();
    </script>
  </div>
</div>
{% endblock %}