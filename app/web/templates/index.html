{% extends "_layout.html" %}
{% block content %}
<!-- full-width search & upload section -->
<div class="full-bleed">
  <div class="card">
    <div class="page-header">
      <h2>Извлечение текста (OCR) и поиск документов</h2>
      <a href="#" onclick="doLogout(); return false;" class="logout-link">Выйти ({{ current_user.email }})</a>
    </div>
 
    <!-- Поиск -->
    <form
      hx-get="{{ request.url_for('search').path }}"
      hx-target="#results"
      hx-swap="innerHTML"
      hx-indicator="#spinner"
      class="field"
      style="margin-top:12px;"
    >
      <div class="row search-row">
        <input type="text" name="q" placeholder="Введите запрос..." class="w-50" />
        <input type="text" name="ocr_user" class="auto" placeholder="user/email" />
        <div class="inline-field auto">
          <label for="ocr_from" class="form-label">от</label>
          <input type="datetime-local" name="ocr_from" />
        </div>
        <div class="inline-field auto">
          <label for="ocr_to" class="form-label">до</label>
          <input type="datetime-local" name="ocr_to" />
        </div>
        <button class="btn" type="submit">Поиск</button>
      </div>
    </form>
 
    <hr />
 
    <!-- Загрузка + запуск фоновой обработки -->
    <form id="uploadForm"
          hx-post="{{ request.url_for('upload').path }}"
          hx-trigger="submit"
          hx-target="#job-panel"
          hx-swap="innerHTML"
          hx-encoding="multipart/form-data"
          hx-indicator="#spinner"
          enctype="multipart/form-data"
          class="field">
      <div class="row upload-row">
        <input type="file" name="files" multiple accept="*.*" required />
        <button class="btn" type="submit">Загрузить</button>
      </div>
    </form>
 
    <!-- Панель прогресса задания (HTMX-поллинг /jobs/{id}) -->
    <div id="job-panel" class="mt-3"></div>
 
    <hr />
 
    <!-- Результаты поиска (и тут же можно видеть результаты загрузки, если хотите переносить их сюда вручную) -->
    <div id="results">
      {% include "_results.html" %}
    </div>
 
  </div>
</div>
 
<script>
  // После ответа на POST /upload (202 + {"job_id": ...}) запускаем поллинг /jobs/{id}
  document.addEventListener("htmx:afterOnLoad", function (e) {
    // интересуют только ответы именно формы upload
    if (!e.detail || !e.detail.elt || e.detail.elt.id !== "uploadForm") return;
 
    try {
      const xhr = e.detail.xhr;
      const resp = JSON.parse(xhr.responseText || "{}");
      if (!resp.job_id) return;
 
      const jobId = resp.job_id;
      const panel = document.getElementById("job-panel");
 
      // Первичное сообщение
      panel.innerHTML = `<div class="muted">Задание ${jobId} создано. Идёт обработка…</div>`;
 
      // Назначаем на панель поллинг статуса
      panel.setAttribute("hx-get", `/jobs/${jobId}`);
      panel.setAttribute("hx-trigger", "load delay:500ms, every 2s");
      panel.setAttribute("hx-swap", "innerHTML");
 
      // Старт первого запроса
      if (window.htmx) htmx.trigger(panel, "load");
    } catch (_) {
      // Если ответ не JSON (ошибка и т.п.) — ничего не делаем
    }
  });
</script>
{% endblock %}
